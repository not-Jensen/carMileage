<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mileage Predictor AI</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1420;
    --surface2: #111927;
    --border: rgba(56,189,248,0.12);
    --border2: rgba(56,189,248,0.25);
    --cyan: #38bdf8;
    --cyan2: #0ea5e9;
    --cyan3: #7dd3fc;
    --text: #e2eaf4;
    --text2: #8ba3be;
    --accent: #f0f9ff;
    --glow: 0 0 30px rgba(56,189,248,0.15);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Space Grotesk', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(56,189,248,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(56,189,248,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
    z-index: 0;
  }

  /* Radial glow */
  body::after {
    content: '';
    position: fixed;
    top: -200px; left: 50%;
    transform: translateX(-50%);
    width: 800px; height: 600px;
    background: radial-gradient(ellipse, rgba(56,189,248,0.06) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
  }
  .logo-icon {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--cyan), var(--cyan2));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: 0 0 20px rgba(56,189,248,0.3);
  }
  h1 {
    font-size: clamp(24px, 4vw, 36px);
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  h1 span { color: var(--cyan); }
  .tagline {
    color: var(--text2);
    font-size: 14px;
    margin-bottom: 40px;
    margin-left: 60px;
  }

  /* Layout */
  .layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
  }
  @media(max-width: 900px) {
    .layout { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.4), transparent);
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--cyan);
    margin-bottom: 24px;
  }
  .card-title svg { opacity: 0.8; }

  /* Form grid */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .form-grid .full { grid-column: 1/-1; }
  @media(max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-grid .full { grid-column: 1; }
  }

  .field label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text2);
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .field input, .field select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 14px;
    font-weight: 500;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }
  .field select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2338bdf8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 36px;
    cursor: pointer;
  }
  .field input:focus, .field select:focus {
    border-color: var(--cyan2);
    box-shadow: 0 0 0 3px rgba(56,189,248,0.1);
  }
  .field input::placeholder { color: rgba(139,163,190,0.5); }
  .field select option { background: #111927; }

  /* Mono inputs for numbers */
  .field input[type="number"] {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
  }
  .field input[type="number"]::-webkit-inner-spin-button { display: none; }

  /* Button */
  .predict-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--cyan), var(--cyan2));
    border: none;
    border-radius: 12px;
    color: #080c14;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 0.03em;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
    margin-top: 20px;
    box-shadow: 0 4px 24px rgba(56,189,248,0.25);
  }
  .predict-btn:hover { opacity: 0.92; transform: translateY(-1px); box-shadow: 0 8px 32px rgba(56,189,248,0.35); }
  .predict-btn:active { transform: translateY(0); }
  .predict-btn.loading { opacity: 0.7; cursor: not-allowed; }

  /* Right panel */
  .right-panel { display: flex; flex-direction: column; gap: 20px; }

  /* Result card */
  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px;
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: border-color 0.4s;
  }
  .result-card.active { border-color: rgba(56,189,248,0.35); box-shadow: var(--glow); }
  .result-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.4), transparent);
  }

  .result-label {
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text2);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .result-label svg { color: var(--cyan); }

  .result-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 72px;
    font-weight: 500;
    color: var(--cyan);
    line-height: 1;
    margin-bottom: 4px;
    transition: all 0.4s;
    filter: drop-shadow(0 0 20px rgba(56,189,248,0.3));
  }
  .result-unit { font-size: 22px; color: var(--cyan3); vertical-align: super; font-weight: 400; }
  .result-placeholder {
    font-size: 48px;
    color: rgba(56,189,248,0.15);
    letter-spacing: 8px;
  }

  .result-range {
    margin-top: 16px;
    padding: 10px 16px;
    background: rgba(56,189,248,0.06);
    border: 1px solid rgba(56,189,248,0.12);
    border-radius: 8px;
    display: inline-block;
  }
  .result-range .range-label { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text2); display: block; margin-bottom: 4px; }
  .result-range .range-val { font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--cyan3); font-weight: 500; }

  .traffic-badge {
    margin-top: 16px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(56,189,248,0.08);
    border: 1px solid rgba(56,189,248,0.15);
    border-radius: 20px;
    font-size: 12px;
    color: var(--text2);
  }
  .traffic-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--cyan);
    box-shadow: 0 0 6px rgba(56,189,248,0.6);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.85); }
  }

  /* Feature importance */
  .importance-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  .importance-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(56,189,248,0.4), transparent);
  }

  .feat-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }
  .feat-row:last-child { margin-bottom: 0; }
  .feat-name {
    font-size: 11px;
    color: var(--text2);
    width: 110px;
    flex-shrink: 0;
    letter-spacing: 0.02em;
  }
  .feat-bar-wrap {
    flex: 1;
    height: 5px;
    background: rgba(56,189,248,0.08);
    border-radius: 99px;
    overflow: hidden;
  }
  .feat-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan2), var(--cyan));
    border-radius: 99px;
    width: 0;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .feat-pct {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--cyan3);
    width: 36px;
    text-align: right;
    flex-shrink: 0;
  }

  /* Status messages */
  .status {
    font-size: 12px;
    color: var(--text2);
    text-align: center;
    padding: 20px;
    opacity: 0.7;
  }

  /* Animate in */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .card, .result-card, .importance-card {
    animation: fadeUp 0.5s ease both;
  }
  .right-panel .result-card { animation-delay: 0.1s; }
  .right-panel .importance-card { animation-delay: 0.2s; }

  /* Error toast */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: #1a0a0a;
    border: 1px solid rgba(239,68,68,0.3);
    color: #fca5a5;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 13px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 100;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo-icon">üöó</div>
    <h1>Mileage <span>Predictor</span> AI</h1>
  </header>
  <p class="tagline">Real-world fuel efficiency estimates powered by a Random Forest model trained on Indian vehicle data</p>

  <div class="layout">
    <!-- Left: Form -->
    <div class="card">
      <div class="card-title">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Vehicle Parameters
      </div>

      <div class="form-grid">
        <div class="field">
          <label>Brand</label>
          <select id="brand"><option value="">Select brand...</option></select>
        </div>
        <div class="field">
          <label>Model</label>
          <select id="model"><option value="">Select model...</option></select>
        </div>
        <div class="field">
          <label>Total KM Driven</label>
          <input type="number" id="total_km" placeholder="e.g. 50000" min="0" max="500000">
        </div>
        <div class="field">
          <label>Engine (CC)</label>
          <input type="number" id="engine_cc" placeholder="e.g. 1497" min="500" max="8000">
        </div>
        <div class="field">
          <label>Fuel Type</label>
          <select id="fuel_type"><option value="">Select fuel...</option></select>
        </div>
        <div class="field">
          <label>Transmission</label>
          <select id="transmission"><option value="">Select type...</option></select>
        </div>
        <div class="field full">
          <label>üìç City (Traffic Adjusted)</label>
          <select id="city"><option value="">Select city...</option></select>
        </div>
        <div class="field">
          <label>Vehicle Age (Years)</label>
          <input type="number" id="age" placeholder="e.g. 3" min="0" max="30">
        </div>
        <div class="field">
          <label>Number of Owners</label>
          <input type="number" id="owners" placeholder="e.g. 1" min="1" max="10">
        </div>
      </div>

      <button class="predict-btn" onclick="predict()">
        ‚ö° Predict Mileage
      </button>
    </div>

    <!-- Right: Results -->
    <div class="right-panel">
      <div class="result-card" id="resultCard">
        <div class="result-label">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
          Prediction Result
        </div>
        <div id="resultDisplay">
          <div class="result-placeholder">‚Äî</div>
          <div class="status">Enter vehicle details and click predict</div>
        </div>
      </div>

      <div class="importance-card" id="importanceCard">
        <div class="card-title">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Model Decisions
        </div>
        <div id="importanceBars">
          <div class="status">Awaiting prediction...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let metadata = {};

async function loadMetadata() {
  try {
    const res = await fetch('/api/metadata');
    metadata = await res.json();
    populate();
  } catch(e) {
    showToast('Failed to connect to prediction server');
  }
}

function populate() {
  // Brands
  const brandSel = document.getElementById('brand');
  metadata.brands.forEach(b => {
    brandSel.innerHTML += `<option value="${b}">${b}</option>`;
  });

  // Models
  const modelSel = document.getElementById('model');
  metadata.models.forEach(m => {
    modelSel.innerHTML += `<option value="${m}">${m}</option>`;
  });

  // Fuel types
  const fuelSel = document.getElementById('fuel_type');
  metadata.fuel_types.forEach(f => {
    fuelSel.innerHTML += `<option value="${f}">${f}</option>`;
  });

  // Transmissions
  const transSel = document.getElementById('transmission');
  metadata.transmissions.forEach(t => {
    transSel.innerHTML += `<option value="${t}">${t}</option>`;
  });

  // Cities
  const citySel = document.getElementById('city');
  const sortedCities = metadata.cities.sort((a, b) => 
    (metadata.city_scores[b] || 0) - (metadata.city_scores[a] || 0)
  );
  sortedCities.forEach(c => {
    const score = metadata.city_scores[c] || 0;
    citySel.innerHTML += `<option value="${c}">${c} (Traffic: ${score})</option>`;
  });
}

function getTrafficLabel(score) {
  if (score >= 85) return { label: 'Very Heavy', color: '#ef4444' };
  if (score >= 70) return { label: 'Heavy', color: '#f97316' };
  if (score >= 50) return { label: 'Moderate', color: '#eab308' };
  return { label: 'Light', color: '#22c55e' };
}

async function predict() {
  const fields = {
    brand: document.getElementById('brand').value,
    model: document.getElementById('model').value,
    total_km: document.getElementById('total_km').value,
    engine_cc: document.getElementById('engine_cc').value,
    fuel_type: document.getElementById('fuel_type').value,
    transmission: document.getElementById('transmission').value,
    city: document.getElementById('city').value,
    age: document.getElementById('age').value,
    owners: document.getElementById('owners').value
  };

  const missing = Object.entries(fields).filter(([k,v]) => !v);
  if (missing.length) {
    showToast('Please fill in all fields');
    return;
  }

  const btn = document.querySelector('.predict-btn');
  btn.classList.add('loading');
  btn.textContent = '‚è≥ Predicting...';

  try {
    const res = await fetch('/api/predict', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(fields)
    });
    const data = await res.json();

    // Show result
    const card = document.getElementById('resultCard');
    card.classList.add('active');

    const traffic = getTrafficLabel(data.traffic_score);
    
    document.getElementById('resultDisplay').innerHTML = `
      <div class="result-value">${data.prediction}<span class="result-unit">km/L</span></div>
      <div class="result-range">
        <span class="range-label">Expected Range</span>
        <span class="range-val">${data.range_low} ‚Äì ${data.range_high} km/L</span>
      </div>
      <div style="margin-top:12px;">
        <div class="traffic-badge">
          <div class="traffic-dot" style="background:${traffic.color}; box-shadow: 0 0 6px ${traffic.color}80;"></div>
          <span>${fields.city} ‚Äî ${traffic.label} Traffic (${data.traffic_score})</span>
        </div>
      </div>
    `;

    // Feature importances
    const imp = data.importances;
    const maxVal = Math.max(...Object.values(imp));
    const names = {
      'Total_km_driven': 'KM Driven',
      'Engine_cc': 'Engine CC',
      'City_traffic_score': 'Traffic',
      'Age_of_vehicle': 'Vehicle Age',
      'Number_of_owners': 'Owners',
      'Brand': 'Brand',
      'Model': 'Model',
      'Fuel_type': 'Fuel Type',
      'Transmission': 'Transmission'
    };

    const sorted = Object.entries(imp).sort((a,b) => b[1]-a[1]);
    let html = '';
    for (const [key, val] of sorted) {
      const pct = Math.round((val / maxVal) * 100);
      const label = names[key] || key;
      html += `
        <div class="feat-row">
          <div class="feat-name">${label}</div>
          <div class="feat-bar-wrap"><div class="feat-bar" data-w="${pct}"></div></div>
          <div class="feat-pct">${Math.round(val * 100)}%</div>
        </div>
      `;
    }
    document.getElementById('importanceBars').innerHTML = html;

    // Animate bars
    requestAnimationFrame(() => {
      document.querySelectorAll('.feat-bar').forEach(bar => {
        bar.style.width = bar.dataset.w + '%';
      });
    });

  } catch(e) {
    showToast('Prediction failed. Is the server running?');
  } finally {
    btn.classList.remove('loading');
    btn.textContent = '‚ö° Predict Mileage';
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

loadMetadata();
</script>
</body>
</html>
